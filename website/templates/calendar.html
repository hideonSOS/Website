<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚¢ã‚¯ã‚¢ãƒ©ã‚¤ãƒ–ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»å‡ºæ¼”è€…</title>
  <!--
    ã“ã‚Œã¯é»’èƒŒæ™¯ã®æœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚
    â— ãƒ•ãƒ­ãƒ³ãƒˆå˜ä½“ã§å‹•ä½œï¼šlocalStorage ã¸ä¿å­˜ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
    â— ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é€£æºï¼ˆä»»æ„ï¼‰ï¼š/api/events ã‚’å©ã„ã¦åŒæœŸ

    â–¼ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã®æƒ³å®šï¼ˆä¾‹ï¼šDjango / FastAPI ç­‰ï¼‰
      GET    /api/events?month=YYYY-MM               -> [{id, date:"YYYY-MM-DD", title, time?, description?}]
      POST   /api/events                              -> å—ä¿¡JSON {date, title, time?, description?} ã‚’ç™»éŒ²ã—ã¦ {id, ...} ã‚’è¿”ã™
      DELETE /api/events/{id}                         -> ãã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤

    â–¼ Django ã®å ´åˆã®CSRF
      ãƒ»Cookie å: csrftoken ã‚’èª­ã¿ã€fetch ãƒ˜ãƒƒãƒ€ã« 'X-CSRFToken' ã‚’ä»˜ä¸ã—ã¦ãã ã•ã„ã€‚

    â–¼ ä½¿ã„æ–¹
      1) ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ã¾ã¾é–‹ãã¨ã€ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ¢ãƒ¼ãƒ‰ï¼ˆlocalStorageï¼‰ã§å‹•ãã¾ã™ã€‚
      2) åŒæœŸå…ˆAPIã‚’ç”¨æ„ã—ãŸã‚‰ const API_BASE = '' ã‚’ç©ºæ–‡å­—ã®ã¾ã¾ã§ã‚‚
         çµ¶å¯¾/ç›¸å¯¾ã§ '/api/events' ã‚’å©ãã¾ã™ï¼ˆå¤±æ•—ã—ãŸã‚‰è‡ªå‹•ã§ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ã€‚
  -->
  <style>
    :root{
      --bg: #000;          /* èƒŒæ™¯ï¼ˆé»’ï¼‰ */
      --fg: #e5e7eb;       /* æ–‡å­—è‰²ï¼ˆæ˜ç°ï¼‰ */
      --muted: #9ca3af;    /* è£œåŠ©æ–‡å­— */
      --accent: #22d3ee;   /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼ˆã‚·ã‚¢ãƒ³ï¼‰ */
      --grid: #1f2937;     /* ã‚°ãƒªãƒƒãƒ‰ç·š */
      --cell: #0b0b0b;     /* ã‚»ãƒ«èƒŒæ™¯ */
      --cell-hover: #111827; /* ã‚»ãƒ«hover */
      --other-month: #0a0a0a; /* å‰å¾Œæœˆã‚»ãƒ« */
      --sun: #f87171;      /* æ—¥æ›œ */
      --sat: #60a5fa;      /* åœŸæ›œ */
    }
    html, body { height: 100%; }
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic UI", "Meiryo", sans-serif;
      line-height:1.5; -webkit-font-smoothing:antialiased;
    }
    .container{ max-width:1100px; margin:0 auto; padding:24px 16px 48px; }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header{ display:flex; align-items:center; gap:12px; justify-content:space-between; margin-bottom:12px; }
    .left, .right{ display:flex; align-items:center; gap:8px; }
    .brand{ font-size:18px; color:var(--muted); letter-spacing:.04em; }
    .monthLabel{ font-size:28px; font-weight:700; letter-spacing:.02em; }
    .badge{ font-size:12px; padding:2px 8px; border:1px solid var(--grid); border-radius:999px; color:var(--muted); }

    button{ cursor:pointer; border:none; border-radius:12px; background:#0f172a; color:var(--fg); padding:10px 14px; font-weight:600; }
    button:hover{ background:#111827; }
    .iconbtn{ width:42px; height:42px; display:grid; place-items:center; border-radius:12px; }

    /* æ›œæ—¥ãƒ˜ãƒƒãƒ€ */
    .weekday{ display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; margin-top:10px; }
    .weekday div{ text-align:center; padding:10px 0; font-size:12px; color:var(--muted); border-bottom:1px solid var(--grid); }
    .weekday .sun{ color:var(--sun); }
    .weekday .sat{ color:var(--sat); }

    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æœ¬ä½“ */
    .grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; margin-top:8px; }
    .day{
      position:relative; min-height:220px; background:var(--cell); border:1px solid var(--grid); border-radius:12px; padding:8px; overflow:hidden;
      transition: background .15s ease;
    }
    .day:hover{ background:var(--cell-hover); }
    .day.other{ background:var(--other-month); opacity:.7; }
    .num{
      position:absolute; top:8px; right:10px; font-size:12px; color:var(--muted);
    }
    .today{ outline:2px solid var(--accent); outline-offset:-2px; }

    .events{ margin-top:22px; display:flex; flex-direction:column; gap:6px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; font-size:12px; background:#0d3b45; border:1px solid #134e5a; padding:6px 8px; border-radius:999px; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
    .pill .time{ color:#a7f3d0; font-weight:700; }

    /* ãƒ•ãƒƒã‚¿ã®èª¬æ˜ */
    .help{ margin-top:14px; color:var(--muted); font-size:12px; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆ<dialog>ï¼‰ */
    dialog{ border:none; border-radius:16px; padding:0; width:min(560px, 92vw); background:#0b1220; color:var(--fg); box-shadow:0 20px 60px rgba(0,0,0,.6); }
    dialog::backdrop{ background:rgba(0,0,0,.6); }
    .modalHead{ display:flex; align-items:center; gap:10px; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--grid); }
    .modalTitle{ font-weight:700; }
    .modalBody{ padding:18px; display:grid; gap:14px; }
    .row{ display:grid; gap:6px; }
    label{ font-size:12px; color:var(--muted); }
    input[type="text"], input[type="time"], input[type="date"], textarea{ background:#0f172a; color:var(--fg); border:1px solid var(--grid); border-radius:10px; padding:10px 12px; outline:none; color-scheme: dark; }
    textarea{ min-height:80px; resize:vertical; }
    .modalFoot{ display:flex; justify-content:space-between; align-items:center; padding:16px 18px; border-top:1px solid var(--grid); }
    .danger{ background:#3f1d1d; }
    .danger:hover{ background:#4a2323; }

    .listEmpty{ color:var(--muted); font-size:12px; }
    .eventList{ display:flex; flex-direction:column; gap:8px; }
    .eventItem{ display:flex; align-items:center; justify-content:space-between; border:1px solid var(--grid); background:#0f172a; padding:8px 10px; border-radius:10px; }
    .eventItem .meta{ display:flex; gap:8px; font-size:12px; color:var(--muted); }
    /* 3ãƒ¬ãƒ¼ãƒ³ï¼ˆMC/è§£èª¬è€…1/è§£èª¬è€…2ï¼‰ç”¨ */
    .lanes{ display:grid; grid-template-rows: repeat(4, 1fr); gap:6px; margin-top:24px; }
    .lane{ display:flex; flex-direction:column; gap:6px; border:1px dashed var(--grid); border-radius:10px; padding:6px; }
    .laneTitle{ font-size:11px; color:var(--muted); letter-spacing:.02em; }
    .laneBody{ display:flex; flex-direction:column; gap:6px; }
  /* é–‹å‚¬æ—¥è‰²åˆ†ã‘ */
    .day.race{ background:#0b1e2e; border-color:#1e3a5f; }
    .day.race:hover{ background:#0d2540; }
    .raceTag{ position:absolute; top:8px; left:10px; font-size:11px; padding:2px 6px; border-radius:8px; background:#102846; border:1px solid #1e3a5f; color:#93c5fd; }
  /* å…¥åŠ›ãƒ”ãƒƒã‚«ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ˜ã‚‹ã„é’ã« */
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator{
      filter: invert(78%) sepia(24%) saturate(1000%) hue-rotate(145deg) brightness(110%) contrast(100%);
      cursor:pointer;
    }
    input[type="checkbox"]{ accent-color: var(--accent); }
  /* ãƒ¡ãƒ¢è¡¨ç¤º */
    .memo{ font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .noteIcon{ font-size:12px; opacity:.9; }
  .num {
  color: #00e5ff;  /* ä¾‹ï¼šã‚´ãƒ¼ãƒ«ãƒ‰ */
  font-weight: bold; /* å¤ªå­—ã«ã™ã‚‹å ´åˆ */
  font-size:12px;
}
.header {
  position: sticky;
  top: 0;
  background: #000;  /* èƒŒæ™¯ã‚’æŒ‡å®šã—ãªã„ã¨ä¸‹ã®è¦ç´ ãŒé€ã‘ã‚‹ */
  z-index: 100;      /* å‰é¢ã«å‡ºã™ */
}
.btn-link {
    display: inline-block;
    padding: 5px 16px;
    background: #0f172a;   /* ãƒœã‚¿ãƒ³èƒŒæ™¯è‰² */
    color: #e5e7eb;       /* æ–‡å­—è‰² */
    border: 1px solid #334155;
    border-radius: 10px;
    text-decoration: none; /* aã‚¿ã‚°ã®ä¸‹ç·šã‚’æ¶ˆã™ */
    font-weight: bold;
    cursor: pointer;
    font-size: 12px;
  }
  .btn-link:hover {
    background: #111827; /* hoveræ™‚ã®è‰² */
  }
  .monthLabel {
  font-size: 22px;
  font-weight: 700;
  letter-spacing: .02em;
}
</style>
</head>
<body>
  <div class="container">
    <div class="header" aria-label="ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
      <div class="left">
        <button class="iconbtn" id="prevBtn" aria-label="å‰ã®æœˆã¸">â—€</button>
        <div class="monthLabel" id="monthLabel">----</div>
        <button class="iconbtn" id="nextBtn" aria-label="æ¬¡ã®æœˆã¸">â–¶</button>
      </div>
      <div class="right">
        <span class="badge" id="modeBadge" title="ã‚µãƒ¼ãƒãƒ¼ã¨ç–é€šã§ããªã„å ´åˆã¯è‡ªå‹•ã§ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã«åˆ‡æ›¿">ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šä¸­â€¦</span>
        <button id="todayBtn" aria-label="ä»Šæœˆã¸">ä»Šæ—¥ã¸</button>
        <a class="btn-link" href= "{% url 'website:index' %}">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</a>
      </div>
    </div>

    <div class="weekday" aria-hidden="true">
      <div>æœˆ</div>
      <div>ç«</div>
      <div>æ°´</div>
      <div>æœ¨</div>
      <div>é‡‘</div>
      <div class="sat">åœŸ</div>
      <div class="sun">æ—¥</div>
    </div>

    <div class="grid" id="grid" role="grid" aria-label="æœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼"></div>

    <p class="help">ãƒ’ãƒ³ãƒˆï¼šæ—¥ä»˜ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è¿½åŠ ã§ãã¾ã™ã€‚ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯ ESC ã¾ãŸã¯èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã¾ã™ï¼ˆÃ—ãƒœã‚¿ãƒ³ã¯éè¡¨ç¤ºï¼‰ã€‚</p>
  </div>

  <!-- è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼‰ -->
  <dialog id="eventDialog">
    <form id="eventForm">
      <div class="modalHead">
        <div class="modalTitle" id="dialogTitle">äºˆå®šã‚’è¿½åŠ </div>
        <!-- Ã—ãƒœã‚¿ãƒ³ã¯ç½®ã‹ãšã€ESC/èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹æ–¹é‡ -->
      </div>
      <div class="modalBody">
        <div class="row">
          <label for="dateInput">æ—¥ä»˜</label>
          <input type="date" id="dateInput" required />
        </div>
        <div class="row">
          <label for="roleSelect">å½¹å‰²</label>
          <select id="roleSelect">
            <option value="MC">MC</option>
            <option value="è§£èª¬è€…1">è§£èª¬è€…1</option>
            <option value="è§£èª¬è€…2">è§£èª¬è€…2</option>
            <option value="ã‚²ã‚¹ãƒˆ">ã‚²ã‚¹ãƒˆ</option>
          </select>
        </div>
        <div class="row">
          <label><input type="checkbox" id="isRaceDay"> é–‹å‚¬æ—¥</label>
        </div>
        <div class="row">
          <label for="raceTitleInput">é–‹å‚¬ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰</label>
          <input type="text" id="raceTitleInput" placeholder="ä¾‹ï¼šå¤§é˜ªãƒ€ãƒ¼ãƒ“ãƒ¼ç¬¬42å›æ‘‚æ²³æ³‰ç«¶èµ°" />
        </div>
        <div class="row">
          <label for="titleInput">å‡ºæ¼”è€…</label>
          <input type="text" id="titleInput" placeholder="ä¾‹ï¼šå‡ºæ¼”è€…åï¼ˆMCãƒ»è§£èª¬è€…ãƒ»ã‚²ã‚¹ãƒˆï¼‰" />
        </div>
        <div class="row">
          <label for="descInput">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <textarea id="descInput" placeholder="è©³ç´°ãƒ¡ãƒ¢"></textarea>
        </div>
        <div class="row">
          <strong style="font-size:12px; color:var(--muted);">ã“ã®æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆ</strong>
          <div id="eventList" class="eventList"></div>
        </div>
      </div>
      <div class="modalFoot">
        
        <div>
          <button type="submit" id="saveBtn">è¿½åŠ </button>
          <button type="button" id="closeBtn">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </form>
  </dialog>

  <script>
    // =============================
    // è¨­å®š
    // =============================
    const API_BASE = '';
    const ROLE_ORDER = ['MC','è§£èª¬è€…1','è§£èª¬è€…2','ã‚²ã‚¹ãƒˆ']; // ç›¸å¯¾ã§ '/api/events' ã‚’åˆ©ç”¨ã€‚å¤±æ•—æ™‚ã¯è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆlocalStorageï¼‰

    // =============================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // =============================
    const pad = (n) => String(n).padStart(2, '0');
    const fmtDate = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const parseDateStr = (str) => {
      const [y,m,dd] = str.split('-').map(Number);
      return new Date(y, m-1, dd);
    };

    function getCSRFToken(){
      // Djangoæƒ³å®šï¼šcookie "csrftoken" ã‚’è¿”ã™
      const m = document.cookie.match(/(?:^|; )csrftoken=([^;]+)/);
      return m ? decodeURIComponent(m[1]) : '';
    }

    // localStorage ã‚­ãƒ¼
    const LS_KEY = 'calendarEvents_v1';
    const LS_RACE_KEY = 'calendarRace_v1';

    function readLocalRace(){ try{ return JSON.parse(localStorage.getItem(LS_RACE_KEY) || '[]'); }catch{ return []; } }
    function writeLocalRace(list){ localStorage.setItem(LS_RACE_KEY, JSON.stringify(list)); }

    function readLocalEvents(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }catch{ return []; }
    }
    function writeLocalEvents(list){
      localStorage.setItem(LS_KEY, JSON.stringify(list));
    }

    // IDç™ºè¡Œï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç”¨ï¼‰
    function uid(){ return 'ev_' + Date.now().toString(36) + Math.random().toString(36).slice(2,8); }

    // =============================
    // API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆå¤±æ•—æ™‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    // =============================
    let serverAvailable = false; // èµ·å‹•æ™‚ã«åˆ¤å®š

    async function tryServer(){
      // é©å½“ãªæœˆã§è»½ã GET ã‚’è©¦ã¿ã¦ç–é€šç¢ºèª
      try{
        const now = new Date();
        const ym = `${now.getFullYear()}-${pad(now.getMonth()+1)}`;
        const res = await fetch(`/api/events?month=${ym}`, { method:'GET' });
        serverAvailable = res.ok; // 200ç³»ãªã‚‰åˆ©ç”¨
      }catch{
        serverAvailable = false;
      }
      updateModeBadge();
    }

    function updateModeBadge(){
      const badge = document.getElementById('modeBadge');
      if(serverAvailable){
        badge.textContent = '';
        badge.style.color = '#a7f3d0';
        badge.style.borderColor = '#134e5a';
      }else{
        badge.textContent = 'ã‚¹ãƒãƒ›ã®æ–¹ã¯ç”»é¢ã‚’æ¨ªã«ã—ã¦ã”è¦§ãã ã•ã„ã€‚';
        badge.style.color = '#fde68a';
        badge.style.borderColor = '#4b5563';
      }
    }

    async function fetchEventsByMonth(year, month){
      const ym = `${year}-${pad(month)}`;
      if(serverAvailable){
        try{
          const res = await fetch(`/api/events?month=${ym}`, { method:'GET' });
          if(res.ok) return await res.json();
        }catch{ /* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */ }
      }
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰æœˆæŠ½å‡º
      const all = readLocalEvents();
      return all.filter(ev => (ev.date || '').startsWith(ym));
    }

    async function createEvent(payload){
      // payload: {date, title, time?, description?}
      if(serverAvailable){
        try{
          const res = await fetch(`/api/events`, {
            method:'POST',
            headers:{ 'Content-Type':'application/json', 'X-CSRFToken': getCSRFToken() },
            body: JSON.stringify(payload)
          });
          if(res.ok){ return await res.json(); } // {id, ...}
        }catch{ /* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */ }
      }
      // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
      const list = readLocalEvents();
      const ev = { id: uid(), ...payload };
      list.push(ev); writeLocalEvents(list);
      return ev;
    }

    async function deleteEvent(id){
      if(serverAvailable){
        try{
          const res = await fetch(`/api/events/${encodeURIComponent(id)}`, {
            method:'DELETE', headers:{ 'X-CSRFToken': getCSRFToken() }
          });
          if(res.ok) return true;
        }catch{ /* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */ }
      }
      // ãƒ­ãƒ¼ã‚«ãƒ«å‰Šé™¤
      const list = readLocalEvents();
      const idx = list.findIndex(e => e.id === id);
      if(idx !== -1){ list.splice(idx,1); writeLocalEvents(list); return true; }
      return false;
    }

    async function deleteAllOn(dateStr){
      if(serverAvailable){
        // ã‚µãƒ¼ãƒãƒ¼å´ã«ä¸€æ‹¬å‰Šé™¤APIãŒç„¡ã„å ´åˆã¯å€‹åˆ¥ã«å–å¾—->å‰Šé™¤ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„
        const d = await fetchEventsByMonth(...ymOf(dateStr));
        const targets = d.filter(e => e.date === dateStr);
        for(const t of targets){ await deleteEvent(t.id); }
        return true;
      }else{
        const list = readLocalEvents().filter(e => e.date !== dateStr);
        writeLocalEvents(list); return true;
      }
    }

    function ymOf(dateStr){
      const d = parseDateStr(dateStr);
      return [d.getFullYear(), d.getMonth()+1];
    }

    // ===== é–‹å‚¬æ—¥API/ãƒ­ãƒ¼ã‚«ãƒ« =====
    async function fetchRaceByMonth(year, month){
      const ym = `${year}-${pad(month)}`;
      if(serverAvailable){
        try{
          const res = await fetch(`/api/racedays?month=${ym}`, { method:'GET' });
          if(res.ok) return await res.json();
        }catch{ /* fallback */ }
      }
      const all = readLocalRace();
      return all.filter(r => (r.date||'').startsWith(ym));
    }

    async function upsertRace(payload){ // {date, title}
      if(serverAvailable){
        try{
          const res = await fetch(`/api/racedays`, {
            method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRFToken': getCSRFToken() },
            body: JSON.stringify(payload)
          });
          if(res.ok) return await res.json();
        }catch{ /* fallback */ }
      }
      const list = readLocalRace();
      const idx = list.findIndex(r => r.date === payload.date);
      if(idx !== -1) list[idx] = { ...list[idx], ...payload };
      else list.push({ id: uid(), ...payload });
      writeLocalRace(list);
      return payload;
    }

    async function clearRace(dateStr){
      if(serverAvailable){
        try{
          const res = await fetch(`/api/racedays/${encodeURIComponent(dateStr)}`, { method:'DELETE', headers:{ 'X-CSRFToken': getCSRFToken() } });
          if(res.ok) return true;
        }catch{ /* fallback */ }
      }
      const list = readLocalRace().filter(r => r.date !== dateStr);
      writeLocalRace(list);
      return true;
    }

    // =============================
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
    // =============================
    const gridEl = document.getElementById('grid');
    const monthLabel = document.getElementById('monthLabel');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const todayBtn = document.getElementById('todayBtn');

    let current = new Date(); // ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹æœˆ

    function firstDayOfMonth(y, m){ return new Date(y, m-1, 1); }
    function lastDayOfMonth(y, m){ return new Date(y, m, 0); }

    function buildMonthMatrix(y, m){
      const first = firstDayOfMonth(y,m);
      const last = lastDayOfMonth(y,m);
      const startIndex = (first.getDay() + 6) % 7; // 0=æœˆ
      const daysInMonth = last.getDate();

      const cells = [];
      // å‰æœˆåˆ†
      const prevLast = lastDayOfMonth(y, m-1);
      for(let i=0;i<startIndex;i++){
        const day = prevLast.getDate() - (startIndex - 1 - i);
        const d = new Date(y, m-2, day);
        cells.push({ date:d, inMonth:false });
      }
      // ä»Šæœˆåˆ†
      for(let d=1; d<=daysInMonth; d++){
        cells.push({ date:new Date(y, m-1, d), inMonth:true });
      }
      // æ¬¡æœˆåˆ†ã§ 6è¡ŒÃ—7åˆ—=42ã‚»ãƒ«ã«åŸ‹ã‚ã‚‹
      while(cells.length < 42){
        const lastCell = cells[cells.length-1].date;
        const d = new Date(lastCell.getFullYear(), lastCell.getMonth(), lastCell.getDate()+1);
        cells.push({ date:d, inMonth: d.getMonth() === (m-1) });
      }
      return cells;
    }

    async function render(){
      const y = current.getFullYear();
      const m = current.getMonth()+1;
      monthLabel.textContent = `${y}å¹´${m}æœˆ`;
      gridEl.innerHTML = '';

      const cells = buildMonthMatrix(y,m);
      const monthly = await fetchEventsByMonth(y,m);
      const raceMonthly = await fetchRaceByMonth(y,m);
      const raceMap = new Map(raceMonthly.map(r => [r.date, r]));
      const byDate = new Map();
      for(const e of monthly){
        if(!byDate.has(e.date)) byDate.set(e.date, []);
        byDate.get(e.date).push(e);
      }
      // Sort events by time then title
      for(const list of byDate.values()){
        list.sort((a,b)=> (ROLE_ORDER.indexOf((a.role||'MC')) - ROLE_ORDER.indexOf((b.role||'MC'))) || a.title.localeCompare(b.title));
      }

      const todayStr = fmtDate(new Date());

      for(const c of cells){
        const d = c.date;
        const cell = document.createElement('div');
        cell.className = 'day' + (c.inMonth?'':' other');
        const dateStr = fmtDate(d);
        if(dateStr === todayStr) cell.classList.add('today');

        const num = document.createElement('div');
        num.className='num';
        num.textContent = d.getDate();
        cell.appendChild(num);

        // é–‹å‚¬æ—¥ã‚«ãƒ©ãƒ¼ & ã‚¿ã‚°
        const rinfo = raceMap.get(dateStr);
        if(rinfo){
          cell.classList.add('race');
          cell.title = rinfo.title ? `é–‹å‚¬: ${rinfo.title}` : 'é–‹å‚¬';
          const tag = document.createElement('div');
          tag.className = 'raceTag';
          tag.textContent = rinfo.title ? `é–‹å‚¬: ${rinfo.title}` : 'é–‹å‚¬';
          cell.appendChild(tag);
        }

        const roles = ['MC','è§£èª¬è€…1','è§£èª¬è€…2','ã‚²ã‚¹ãƒˆ'];
        const allEvents = (byDate.get(dateStr) || []).map(e => ({...e, role: e.role || 'MC'}));

        const lanes = document.createElement('div');
        lanes.className = 'lanes';
        for(const role of roles){
          const lane = document.createElement('div');
          lane.className = 'lane';

          const laneTitle = document.createElement('div');
          laneTitle.className = 'laneTitle';
          laneTitle.textContent = role;
          lane.appendChild(laneTitle);

          const laneBody = document.createElement('div');
          laneBody.className = 'laneBody';

          const items = allEvents.filter(e => e.role === role);
          if(items.length === 0){
            const empty = document.createElement('div');
            empty.className = 'listEmpty';
            empty.textContent = 'â€”';
            laneBody.appendChild(empty);
          }else{
            for(const ev of items){
              const pill = document.createElement('div');
              pill.className='pill';
              pill.title = ev.description || ''; const title = document.createElement('span'); title.textContent = ev.title; pill.appendChild(title);
              if (ev.description) {
                const note = document.createElement('span');
                note.className = 'noteIcon';
                note.textContent = 'ğŸ“';
                pill.appendChild(note);
                pill.title = ev.description;
              }
              laneBody.appendChild(pill);
            }
          }
          lane.appendChild(laneBody);
          lanes.appendChild(lane);
        }
        cell.appendChild(lanes);

        // ã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«
        cell.addEventListener('click', () => openDialogFor(dateStr));
        gridEl.appendChild(cell);
      }
    }

    prevBtn.addEventListener('click', ()=>{ current = new Date(current.getFullYear(), current.getMonth()-1, 1); render(); });
    nextBtn.addEventListener('click', ()=>{ current = new Date(current.getFullYear(), current.getMonth()+1, 1); render(); });
    todayBtn.addEventListener('click', ()=>{ const now = new Date(); current = new Date(now.getFullYear(), now.getMonth(), 1); render(); });

    // =============================
    // ãƒ¢ãƒ¼ãƒ€ãƒ« & ãƒ•ã‚©ãƒ¼ãƒ 
    // =============================
    const dialog = document.getElementById('eventDialog');
    const dateInput = document.getElementById('dateInput');
    const roleSelect = document.getElementById('roleSelect');
    const isRaceDay = document.getElementById('isRaceDay');
    const raceTitleInput = document.getElementById('raceTitleInput');
    const titleInput = document.getElementById('titleInput');
    const descInput = document.getElementById('descInput');
    const eventList = document.getElementById('eventList');
    
    const closeBtn = document.getElementById('closeBtn');
    const form = document.getElementById('eventForm');

    function clearForm(){
      titleInput.value = '';
      descInput.value = '';
      if(roleSelect) roleSelect.value = 'MC';
    }

    async function refreshEventList(dateStr){
      eventList.innerHTML = '';
      const [y,m] = ymOf(dateStr);
      const list = (await fetchEventsByMonth(y,m)).filter(e => e.date === dateStr);
      if(list.length === 0){
        const p = document.createElement('div'); p.className='listEmpty'; p.textContent = 'ã“ã®æ—¥ã®äºˆå®šã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“';
        eventList.appendChild(p);
        return;
      }
      for(const ev of list){
        const row = document.createElement('div'); row.className='eventItem';
        const left = document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column';
        const title = document.createElement('div'); title.textContent = `[${ev.role || 'MC'}] ${ev.title}`;
        const meta = document.createElement('div');
        meta.className='meta';
        meta.innerHTML = `${ev.description ? '<span>ğŸ“ãƒ¡ãƒ¢ã‚ã‚Š</span>' : ''}`;
        left.appendChild(title); left.appendChild(meta);
        if (ev.description){
          const memo = document.createElement('div');
          memo.className = 'memo';
          memo.textContent = ev.description;
          left.appendChild(memo);
        }

        const del = document.createElement('button'); del.className='danger'; del.textContent='å‰Šé™¤';
        del.addEventListener('click', async (e)=>{
          e.preventDefault();
          await deleteEvent(ev.id);
          await refreshEventList(dateStr);
      setRaceFields(dateStr);
          await render();
        });
        row.appendChild(left); row.appendChild(del);
        eventList.appendChild(row);
      }
    }

    async function readRaceForDate(dateStr){
      const [y,m] = ymOf(dateStr);
      const list = await fetchRaceByMonth(y,m);
      return list.find(r => r.date === dateStr) || null;
    }
    async function setRaceFields(dateStr){
      if(!isRaceDay || !raceTitleInput) return;
      const r = await readRaceForDate(dateStr);
      isRaceDay.checked = !!r;
      raceTitleInput.value = r && r.title ? r.title : '';
    }

    function openDialogFor(dateStr){
      dateInput.value = dateStr;
      clearForm();
      dialog.showModal();
      refreshEventList(dateStr);
    }

    // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    dialog.addEventListener('click', (e)=>{
      const rect = dialog.getBoundingClientRect();
      const inside = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
      if(!inside) dialog.close();
    });
    // æ˜ç¤ºãƒœã‚¿ãƒ³ã§é–‰ã˜ã‚‹
    closeBtn.addEventListener('click', ()=> dialog.close());

    // ã“ã®æ—¥ã®äºˆå®šã‚’å…¨å‰Šé™¤
    

    // è¿½åŠ 
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = {
        date: dateInput.value,
        title: titleInput.value.trim(),
        description: descInput.value.trim() || null,
        role: roleSelect.value
      };
      
      const isRace = isRaceDay && isRaceDay.checked;
      const rtitle = raceTitleInput ? raceTitleInput.value.trim() : '';
      if(isRace){ await upsertRace({ date: payload.date, title: rtitle || null }); }
      else { await clearRace(payload.date); }
      if(payload.title){ await createEvent(payload); }
      await refreshEventList(payload.date);
      await render();
      clearForm();
    });

    // åˆæœŸåŒ–
    (async function init(){
      await tryServer();
      await render();
    })();
    roleSelect.addEventListener("click", (e) => {
  e.stopPropagation();
});

  </script>
</body>
</html>
