<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>◯号機 投稿一覧</title>
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #0ff;
      margin-bottom: 30px;
    }
    .controls {
      margin-bottom: 20px;
    }
    select {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #334155;
      background: #0f172a;
      color: #eafb02;
      font-size:30px;
    }
    .post-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .post-card {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 10px;
      padding: 12px;
    }
    .meta {
      font-size: 16px;
      color: #93c5fd;
      margin-bottom: 8px;
      white-space: normal;   /* ← 改行を許可 */
      word-break: break-word; /* ← 長い単語も折り返す */
      overflow-wrap: break-word; /* こちらも保険 */
    }
    .content {
      font-size: 30px;
      line-height: 1.5;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>モーター投稿一覧</h1>

  <!-- 号機を選ぶUI -->
  <div class="controls">
    <label for="machineSelect">モーターを選択：</label>
    <select id="machineSelect"></select>
  </div>

  <div id="output">モーターを選択してください</div>

  <script>
    const API_BASE = "/website/api/machines";
    const machineNo = {{ machine_no }};   // ← Djangoから埋め込まれる
    // ====== fetchPosts ======
    async function fetchPosts(machineNo){
      try{
        const res = await fetch(`${API_BASE}/${machineNo}/posts`, { 
          cache:"no-store", 
          credentials:"same-origin" 
        });
        if(res.ok){ 
          return await res.json(); 
        }
        console.error("GET failed:", res.status, await res.text());
      }catch(e){ 
        console.error("GET error:", e); 
      }
      return [];
    }

    // ====== 画面に表示 ======
    async function renderPosts(machineNo){
      const output = document.getElementById("output");
      const posts = await fetchPosts(machineNo);

      if(posts.length === 0){
        output.textContent = "投稿はありません";
      }else{
        const sorted = posts.slice().sort((a, b) => 
          new Date(b.created_at) - new Date(a.created_at)
        );

        const list = document.createElement("div");
        list.className = "post-list";

        sorted.forEach(p => {
          const card = document.createElement("div");
          card.className = "post-card";

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = `投稿者: ${p.author || "匿名"} ／ 使用していた選手: ${p.racer || "不明"} ／ 投稿日: ${p.scheduled_at || "未設定"}`;

          const content = document.createElement("div");
          content.className = "content";
          content.textContent = p.content || "";

          card.appendChild(meta);
          card.appendChild(content);
          list.appendChild(card);
        });

        output.innerHTML = "";
        output.appendChild(list);
      }
    }

    // ====== 初期化（セレクトボックスに1～100号機を追加） ======
    function initMachineSelect(){
      const select = document.getElementById("machineSelect");
      for(let i=1; i<=100; i++){
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = `${i}号機`;
        select.appendChild(opt);
      }
      // デフォルトで1号機を選択
      select.value = machineNo;
      renderPosts(machineNo);

      // 選択変更時に再描画
      select.addEventListener("change", (e)=>{
        const machineNo = e.target.value;
        renderPosts(machineNo);
      });
    }

    initMachineSelect();
  </script>
</body>
</html>
